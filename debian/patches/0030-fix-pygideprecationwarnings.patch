From 09b3ca137ffd389daac633d206f86466822a4369 Mon Sep 17 00:00:00 2001
From: Will Miller <will.miller@pexip.com>
Date: Tue, 15 Mar 2022 14:41:33 +0000
Subject: [PATCH] internet/glib: fix PyGIDeprecationWarnings

Update GLib API calls to their non-deprecated invocations.
---
 src/twisted/internet/_glibbase.py   |  3 +--
 src/twisted/internet/gireactor.py   |  9 +++------
 src/twisted/internet/gtk2reactor.py | 13 ++++---------
 3 files changed, 8 insertions(+), 17 deletions(-)

diff --git a/src/twisted/internet/_glibbase.py b/src/twisted/internet/_glibbase.py
index 47e162d..4f38edc 100644
--- a/src/twisted/internet/_glibbase.py
+++ b/src/twisted/internet/_glibbase.py
@@ -158,8 +158,7 @@ def wrapper(ignored, condition):
             fileno = source
             wrapper = callback
         return self._glib.io_add_watch(
-            fileno, condition, wrapper,
-            priority=self._glib.PRIORITY_DEFAULT_IDLE)
+            fileno, self._glib.PRIORITY_DEFAULT_IDLE, condition, wrapper)
 
 
     def _ioEventCallback(self, source, condition):
diff --git a/src/twisted/internet/gireactor.py b/src/twisted/internet/gireactor.py
index f1b0d27..5adfaab 100644
--- a/src/twisted/internet/gireactor.py
+++ b/src/twisted/internet/gireactor.py
@@ -60,8 +60,6 @@ def _oldGiInit():
 
     global GLib
     from gi.repository import GLib
-    if getattr(GLib, "threads_init", None) is not None:
-        GLib.threads_init()
 
     _glibbase.ensureNotImported([], "",
                                 preventImports=_PYGTK_MODULES)
@@ -75,15 +73,14 @@ def _oldGiInit():
     # Newer version of gi, so we can try to initialize compatibility layer; if
     # real pygtk was already imported we'll get ImportError at this point
     # rather than segfault, so unconditional import is fine.
-    import gi.pygtkcompat
-    gi.pygtkcompat.enable()
+
+    import pygtkcompat
+    pygtkcompat.enable()
     # At this point importing gobject will get you gi version, and importing
     # e.g. gtk will either fail in non-segfaulty way or use gi version if user
     # does gi.pygtkcompat.enable_gtk(). So, no need to prevent imports of
     # old school pygtk modules.
     from gi.repository import GLib
-    if getattr(GLib, "threads_init", None) is not None:
-        GLib.threads_init()
 
 
 
diff --git a/src/twisted/internet/gtk2reactor.py b/src/twisted/internet/gtk2reactor.py
index faf1234..2aa6c25 100644
--- a/src/twisted/internet/gtk2reactor.py
+++ b/src/twisted/internet/gtk2reactor.py
@@ -43,21 +43,16 @@
     pass # maybe we're using pygtk before this hack existed.
 
 import gobject
-if hasattr(gobject, "threads_init"):
-    # recent versions of python-gtk expose this. python-gtk=2.4.1
-    # (wrapping glib-2.4.7) does. python-gtk=2.0.0 (wrapping
-    # glib-2.2.3) does not.
-    gobject.threads_init()
-
+from gi.repository import GLib
 
 
 class Gtk2Reactor(_glibbase.GlibReactorBase):
     """
     PyGTK+ 2 event loop reactor.
     """
-    _POLL_DISCONNECTED = gobject.IO_HUP | gobject.IO_ERR | gobject.IO_NVAL
-    _POLL_IN = gobject.IO_IN
-    _POLL_OUT = gobject.IO_OUT
+    _POLL_DISCONNECTED = GLib.IO_HUP | GLib.IO_ERR | GLib.IO_NVAL
+    _POLL_IN = GLib.IO_IN
+    _POLL_OUT = GLib.IO_OUT
 
     # glib's iochannel sources won't tell us about any events that we haven't
     # asked for, even if those events aren't sensible inputs to the poll()
