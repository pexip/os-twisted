From de90dfe1519e996dd150de751c670f8e03daa089 Mon Sep 17 00:00:00 2001
From: Adi Roiban <adi.roiban@chevah.com>
Date: Mon, 24 Jan 2022 19:09:04 +0000
Subject: [PATCH] Initial fix for Twisted version string DoS.

---
 src/twisted/conch/ssh/transport.py       |  9 +++++++++
 src/twisted/conch/test/test_transport.py | 22 ++++++++++++++++++++++
 src/twisted/newsfragments/10284.bugfix   |  2 ++
 3 files changed, 33 insertions(+)
 create mode 100644 src/twisted/newsfragments/10284.bugfix

--- a/src/twisted/conch/ssh/transport.py
+++ b/src/twisted/conch/ssh/transport.py
@@ -692,6 +692,15 @@ class SSHTransportBase(protocol.Protocol
         """
         self.buf = self.buf + data
         if not self.gotVersion:
+
+            if len(self.buf) > 4096:
+                self.sendDisconnect(
+                    DISCONNECT_CONNECTION_LOST,
+                    b"Peer version string longer than 4KB. "
+                    b"Preventing a deny of service attack.",
+                )
+                return
+
             if self.buf.find(b'\n', self.buf.find(b'SSH-')) == -1:
                 return
 
--- a/src/twisted/conch/test/test_transport.py
+++ b/src/twisted/conch/test/test_transport.py
@@ -548,6 +548,28 @@ class BaseSSHTransportTests(BaseSSHTrans
         self.assertRegex(softwareVersion, softwareVersionRegex)
 
 
+    def test_dataReceiveVersionNotSentMemoryDOS(self):
+        """
+        When the peer is not sending its SSH version but keeps sending data,
+        the connection is disconnected after 4KB to prevent buffering to
+        much and running our of memory.
+        """
+        sut = MockTransportBase()
+        sut.makeConnection(self.transport)
+
+        sut.dataReceived(b"SSH-bla-bla-bla")
+
+        sut.dataReceived(b"more-bla-bla-bla" * 100)
+
+        self.assertFalse(self.transport.disconnecting)
+
+        sut.dataReceived(b"more-bla-bla-bla" * 1000)
+
+        # Once a lot of data is received without an SSH version string,
+        # the transport is disconnected.
+        self.assertTrue(self.transport.disconnecting)
+        self.assertIn(b"Preventing a deny of service attack", self.transport.value())
+
     def test_sendPacketPlain(self):
         """
         Test that plain (unencrypted, uncompressed) packets are sent
--- /dev/null
+++ b/src/twisted/newsfragments/10284.bugfix
@@ -0,0 +1,2 @@
+twisted.conch.ssh.transport.SSHTransportBase now disconnects the remote peer if the
+SSH version string is not sent in the first 4096 bytes.
